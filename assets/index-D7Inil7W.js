(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const P=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let R,M,h,I,m,u,d,w,f;const F=e=>{f=e},q=e=>{d=e},B=e=>{w=e},$=e=>{R=e},j=e=>{M=e},G=e=>{h=e},z=e=>{m=e},K=e=>{u=e},A="UUID",W="https://opentheso.huma-num.fr/openapi",V=(e,t)=>{for(var n=[],o=-1;(o=t.indexOf(e,o+1))>=0;)n.push(o);return n};function b(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const k=b("selectedResourceLabel"),g=b("configWarning"),U=b("existingIndexationsList"),X=b("selectedThesaurusLabel");b("thesaurusLink");const E=b("searchResults"),J=()=>{g.textContent=`Veuillez créer une colonne qui s'appelle ${A} et qui contient l'uuid de la resource indexée.`,g.style.display="block"},Q=(e,t)=>{g.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,g.style.display="block"},Y=()=>{g.textContent="",g.style.display="none"},Z=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await D(e,t);console.log("currentTableColumnsIds : ",n);const o=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",o),n.filter(s=>o.includes(t.colId[s])).map(s=>({id:t.colId[s],label:t.label[s]}))},D=async(e,t)=>{B(await e.getTableId()),console.log("technicalTableId : ",w);const n=await grist.docApi.fetchTable("_grist_Tables"),o=n.tableId.indexOf(w),s=n.id[o];console.log("gristTableId : ",s);const r=[];let l=t.parentId.indexOf(s);for(;l!==-1;)r.push(l),l=t.parentId.indexOf(s,l+1);return r},ee=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",f),console.log("currentTableFormattedColumns : ",m);const e=f.filter(n=>!m.some(o=>o.id===n.uri)),t=f.filter(n=>!m.some(o=>o.id===n.label));m.map(n=>n.id).includes(A)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),Q(e,t)):Y():(console.warn("Resource URI column is missing, this will cause issues."),J())},te=()=>V(w,d.table).map(t=>({id:d.id[t],manualSort:d.manualSort[t],table:d.table[t],uri:d.uri[t],thesaurus:d.thesaurus[t],label:d.label[t]})),ne=(e,t)=>{console.log("Upserting Grist record with fields:",e),R.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},se=()=>{k.textContent="Pas de ressource sélectionnée",U.innerHTML=""},oe=()=>{k.textContent=u.UUID||""},re=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",f.forEach(t=>{var v,N,S,O;const n=((v=u[t.uri])==null?void 0:v.split(";").filter(c=>c.trim()))||[],o=((N=u[t.label])==null?void 0:N.split(";").filter(c=>c.trim()))||[],s=((S=m.find(c=>c.id===t.label))==null?void 0:S.label)||t.uri,r=new URL(t.thesaurus).searchParams.get("idt"),l=M.find(c=>c.idTheso===r);if(!l){console.error("Thesaurus not found :",t);return}const i=(O=l==null?void 0:l.labels.find(c=>c.lang==="fr"))==null?void 0:O.title,a=document.createElement("li");a.className="indexation-type-item";const y=document.createElement("div");y.className="indexation-type-line";const L=document.createElement("span");L.className="indexation-type-label",L.textContent=s+" ("+(i||"Thésaurus non trouvé")+")",y.appendChild(L);const p=document.createElement("a");p.href=t.thesaurus,p.target="_blank",p.rel="noopener",p.className="thesaurus-link",p.style.marginLeft="8px",p.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',y.appendChild(p),a.appendChild(y);const x=document.createElement("div");x.className="indexation-concept-line";const C=document.createElement("ul");C.className="indexation-concepts-list",n.forEach((c,H)=>{C.appendChild(ae(o,t,c,H))});const T=document.createElement("li");T.className="indexation-concept-item controls-item",!!h&&h.idTheso===r?T.appendChild(ce()):T.appendChild(le(l,t)),C.appendChild(T),x.appendChild(C),a.appendChild(x),e.appendChild(a)}),U.replaceChildren(e)},le=(e,t)=>{const n=document.createElement("button");return n.className="indexation-add-btn",n.title="Sélectionner ce thésaurus",n.textContent="+",n.onclick=o=>{o.stopPropagation(),Le(t,e)},n},ce=()=>{const e=document.createElement("input");return e.type="search",e.placeholder="Rechercher un concept...",e.className="indexation-search",e},ae=(e,t,n,o)=>{const s=e[o]||n,r=document.createElement("li");r.className="indexation-concept-item";const l=document.createElement("span");l.className="indexation-concept-label",l.textContent=s,r.appendChild(l);const i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.className="indexation-concept-link",i.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',r.appendChild(i);const a=document.createElement("button");return a.title="Supprimer",a.className="indexation-concept-delete",a.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',a.onclick=()=>Te(n,o,t.uri,t.label),r.appendChild(a),r},ie=e=>{var n,o;const t=(o=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:o["@id"];if(!t)return null;try{const s=new URL(t,window.location.origin);return new URLSearchParams(s.search).get("idc")||null}catch{return null}},de=()=>{var o;const e=document.createElement("span"),t=document.createElement("span");t.textContent=`${((o=h.labels.find(s=>s.lang==="fr"))==null?void 0:o.title)||h.idTheso}`,e.appendChild(t);const n=document.createElement("a");n.href=`https://opentheso.huma-num.fr/?idt=${h.idTheso}`,n.target="_blank",n.rel="noopener",n.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',e.appendChild(n),X.innerHTML=e.innerHTML},ue=()=>{if(!Array.isArray(I)||I.length===0){E.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&I.forEach(n=>{t.appendChild(pe(n))}),E.innerHTML="",E.appendChild(e)},pe=e=>{const t=document.createElement("tr");he(e);const n=ie(e);me(e);let o=h.idTheso;const s=document.createElement("td");return s.className="broader-cell",s.textContent=n?"Chargement...":"",t.appendChild(s),e.broaderLabel?s.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${o}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:s.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${o}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},he=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(o=>o["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},me=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),_=()=>{if(!u){se();return}oe(),re(),ue()},ge=(e,t,n)=>{const o=u[t].split(";");o.splice(e,1);const s=o.join(";"),r=u[n].split(";");r.splice(e,1);const l=r.join(";");ne({[t]:s,[n]:l},{id:u.id})},be=async()=>await(await fetch(W+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),fe=async()=>{try{be().then(e=>xe(e))}catch(e){console.error(e)}},ye=()=>{de()},Ce=e=>{console.log("New record selected:",e),K(e),_()},Te=(e,t,n,o)=>{console.log("Removing concept: ",e),ge(t,n,o)},we=async()=>{fe(),grist.ready({requiredAccess:"full"}),$(await grist.getTable()),z(await Z(R)),q(await grist.docApi.fetchTable("CONFIG")),F(te()),ee(),grist.onRecord(e=>{Ce(e)})},Le=(e,t)=>{console.log("Indexation type chosen:",e),G(t),ye(),_()},xe=e=>{console.log("Thesauri fetched used to display thesauri labels :",e),j(e)},Ie=async()=>{P(),we()};Ie();
