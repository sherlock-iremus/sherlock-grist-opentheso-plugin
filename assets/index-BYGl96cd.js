(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const j=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let R,k,l,L,m,d,h,x,b;const q=e=>{b=e},B=e=>{h=e},z=e=>{x=e},G=e=>{R=e},K=e=>{k=e},V=e=>{l=e},W=e=>{L=e},X=e=>{m=e},J=e=>{d=e},A="UUID",v="https://opentheso.huma-num.fr/openapi",Q=(e,t)=>{for(var n=[],s=-1;(s=t.indexOf(e,s+1))>=0;)n.push(s);return n};function f(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const U=f("selectedResourceLabel"),g=f("configWarning"),H=f("existingIndexationsList"),Y=f("selectedThesaurusLabel");f("thesaurusLink");const y=f("searchResults"),Z=()=>{g.textContent=`Veuillez créer une colonne qui s'appelle ${A} et qui contient l'uuid de la resource indexée.`,g.style.display="block"},D=(e,t)=>{g.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,g.style.display="block"},ee=()=>{g.textContent="",g.style.display="none"},te=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await ne(e,t);console.log("currentTableColumnsIds : ",n);const s=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",s),n.filter(o=>s.includes(t.colId[o])).map(o=>({id:t.colId[o],label:t.label[o]}))},ne=async(e,t)=>{z(await e.getTableId()),console.log("technicalTableId : ",x);const n=await grist.docApi.fetchTable("_grist_Tables"),s=n.tableId.indexOf(x),o=n.id[s];console.log("gristTableId : ",o);const r=[];let c=t.parentId.indexOf(o);for(;c!==-1;)r.push(c),c=t.parentId.indexOf(o,c+1);return r},se=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",b),console.log("currentTableFormattedColumns : ",m);const e=b.filter(n=>!m.some(s=>s.id===n.uri)),t=b.filter(n=>!m.some(s=>s.id===n.label));m.map(n=>n.id).includes(A)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),D(e,t)):ee():(console.warn("Resource URI column is missing, this will cause issues."),Z())},oe=()=>Q(x,h.table).map(t=>({id:h.id[t],manualSort:h.manualSort[t],table:h.table[t],uri:h.uri[t],thesaurus:h.thesaurus[t],label:h.label[t]})),re=(e,t)=>{console.log("Upserting Grist record with fields:",e),R.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},ce=()=>{U.textContent="Pas de ressource sélectionnée",H.innerHTML=""},le=()=>{U.textContent=d.UUID||""},ae=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",b.forEach(t=>{var S,N,M,O;const n=((S=d[t.uri])==null?void 0:S.split(";").filter(a=>a.trim()))||[],s=((N=d[t.label])==null?void 0:N.split(";").filter(a=>a.trim()))||[],o=((M=m.find(a=>a.id===t.label))==null?void 0:M.label)||t.uri,r=new URL(t.thesaurus).searchParams.get("idt"),c=k.find(a=>a.idTheso===r);if(!c){console.error("Thesaurus not found :",t);return}const u=(O=c==null?void 0:c.labels.find(a=>a.lang==="fr"))==null?void 0:O.title,i=document.createElement("li");i.className="indexation-type-item";const C=document.createElement("div");C.className="indexation-type-line";const I=document.createElement("span");I.className="indexation-type-label",I.textContent=o+" ("+(u||"Thésaurus non trouvé")+")",C.appendChild(I);const p=document.createElement("a");p.href=t.thesaurus,p.target="_blank",p.rel="noopener",p.className="thesaurus-link",p.style.marginLeft="8px",p.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',C.appendChild(p),i.appendChild(C);const E=document.createElement("div");E.className="indexation-concept-line";const T=document.createElement("ul");T.className="indexation-concepts-list",n.forEach((a,F)=>{T.appendChild(ue(s,t,a,F))});const w=document.createElement("li");w.className="indexation-concept-item controls-item",!!l&&l.idTheso===r?w.appendChild(de()):w.appendChild(ie(c,t)),T.appendChild(w),E.appendChild(T),i.appendChild(E),e.appendChild(i)}),H.replaceChildren(e)},ie=(e,t)=>{const n=document.createElement("button");return n.className="indexation-add-btn",n.title="Sélectionner ce thésaurus",n.textContent="+",n.onclick=s=>{s.stopPropagation(),Ne(t,e)},n},de=()=>{const e=document.createElement("input");return e.type="search",e.placeholder="Rechercher un concept...",e.className="indexation-search",e.onkeydown=t=>Me(t,e.value),setTimeout(()=>e.focus(),0),e},ue=(e,t,n,s)=>{const o=e[s]||n,r=document.createElement("li");r.className="indexation-concept-item";const c=document.createElement("span");c.className="indexation-concept-label",c.textContent=o,r.appendChild(c);const u=document.createElement("a");u.href=n,u.target="_blank",u.rel="noopener",u.className="indexation-concept-link",u.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',r.appendChild(u);const i=document.createElement("button");return i.title="Supprimer",i.className="indexation-concept-delete",i.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',i.onclick=()=>ve(n,s,t.uri,t.label),r.appendChild(i),r},P=e=>{var n,s;const t=(s=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:s["@id"];if(!t)return null;try{const o=new URL(t,window.location.origin);return new URLSearchParams(o.search).get("idc")||null}catch{return null}},he=()=>{var s;const e=document.createElement("span"),t=document.createElement("span");t.textContent=`${((s=l.labels.find(o=>o.lang==="fr"))==null?void 0:s.title)||l.idTheso}`,e.appendChild(t);const n=document.createElement("a");n.href=`https://opentheso.huma-num.fr/?idt=${l.idTheso}`,n.target="_blank",n.rel="noopener",n.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',e.appendChild(n),Y.innerHTML=e.innerHTML},pe=()=>{y.innerHTML="Recherche..."},me=e=>{y.innerHTML=e},_=()=>{if(!Array.isArray(L)||L.length===0){y.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&L.forEach(n=>{t.appendChild(ge(n))}),y.innerHTML="",y.appendChild(e)},ge=e=>{const t=document.createElement("tr");fe(e);const n=P(e);be(e);let s=l.idTheso;const o=document.createElement("td");return o.className="broader-cell",o.textContent=n?"Chargement...":"",t.appendChild(o),e.broaderLabel?o.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${s}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:o.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${s}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},fe=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(s=>s["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},be=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),$=()=>{if(!d){ce();return}le(),ae(),_()},ye=(e,t,n)=>{const s=d[t].split(";");s.splice(e,1);const o=s.join(";"),r=d[n].split(";");r.splice(e,1);const c=r.join(";");re({[t]:o,[n]:c},{id:d.id})},Ce=async()=>await(await fetch(v+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),Te=async(e,t)=>await(await fetch(v+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),we=async(e,t)=>await(await fetch(v+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),Le=async()=>{try{Ce().then(e=>Oe(e))}catch(e){console.error(e)}},xe=()=>{he()},Ie=async e=>{if(e.trim()){pe();try{const t=await Te(l.idTheso,e);await Promise.all(t.map(async n=>{const s=P(n);return s&&(n.broaderLabel=(await we(l.idTheso,s)).label),n})),ke(t)}catch(t){let n;d?l&&l.idTheso?(n="Erreur lors de la recherche dans le thésaurus.",console.error(n,l.idTheso,t)):(n="Veuillez d'abord sélectionner un thésaurus.",console.error(n)):(n="Veuillez d'abord sélectionner une ressource.",console.error(n,l.idTheso,t)),me(n)}}},Ee=()=>{_()},Re=e=>{console.log("New record selected:",e),J(e),$()},ve=(e,t,n,s)=>{console.log("Removing concept: ",e),ye(t,n,s)},Se=async()=>{Le(),grist.ready({requiredAccess:"full"}),G(await grist.getTable()),X(await te(R)),B(await grist.docApi.fetchTable("CONFIG")),q(oe()),se(),grist.onRecord(e=>{Re(e)})},Ne=(e,t)=>{console.log("Indexation type chosen:",e),V(t),xe(),$()},Me=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&Ie(t)},Oe=e=>{console.log("Thesauri fetched used to display thesauri labels :",e),K(e)},ke=e=>{console.log("Concepts fetched with search:",e),W(e),Ee()},Ae=async()=>{j(),Se()};Ae();
