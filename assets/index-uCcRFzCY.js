(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const z=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let S,M,d,L,g,i,p,E,y,T;const G=e=>{y=e},W=e=>{p=e},K=e=>{E=e},V=e=>{S=e},X=e=>{M=e},D=e=>{d=e},U=e=>{L=e},J=e=>{g=e},Q=e=>{i=e},Y=e=>{T=e},P="UUID",v="https://opentheso.huma-num.fr/openapi",Z=(e,t)=>{for(var n=[],s=-1;(s=t.indexOf(e,s+1))>=0;)n.push(s);return n};function b(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const F=b("selectedResourceLabel"),f=b("configWarning"),j=b("existingIndexationsList"),ee=b("selectedThesaurusLabel");b("thesaurusLink");const C=b("searchResults"),te=()=>{f.textContent=`Veuillez créer une colonne qui s'appelle ${P} et qui contient l'uuid de la resource indexée.`,f.style.display="block"},ne=(e,t)=>{f.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,f.style.display="block"},se=()=>{f.textContent="",f.style.display="none"},oe=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await re(e,t);console.log("currentTableColumnsIds : ",n);const s=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",s),n.filter(o=>s.includes(t.colId[o])).map(o=>({id:t.colId[o],label:t.label[o]}))},re=async(e,t)=>{K(await e.getTableId()),console.log("technicalTableId : ",E);const n=await grist.docApi.fetchTable("_grist_Tables"),s=n.tableId.indexOf(E),o=n.id[s];console.log("gristTableId : ",o);const r=[];let l=t.parentId.indexOf(o);for(;l!==-1;)r.push(l),l=t.parentId.indexOf(o,l+1);return r},le=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",y),console.log("currentTableFormattedColumns : ",g);const e=y.filter(n=>!g.some(s=>s.id===n.uri)),t=y.filter(n=>!g.some(s=>s.id===n.label));g.map(n=>n.id).includes(P)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),ne(e,t)):se():(console.warn("Resource URI column is missing, this will cause issues."),te())},ce=()=>Z(E,p.table).map(t=>({id:p.id[t],manualSort:p.manualSort[t],table:p.table[t],uri:p.uri[t],thesaurus:p.thesaurus[t],label:p.label[t]})),B=(e,t)=>{console.log("Upserting Grist record with fields:",e),S.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},ae=()=>{F.textContent="Pas de ressource sélectionnée",j.innerHTML=""},ie=()=>{F.textContent=i.UUID||""},de=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",y.forEach(t=>{var A,N,k,O;const n=((A=i[t.uri])==null?void 0:A.split(";").filter(u=>u.trim()))||[],s=((N=i[t.label])==null?void 0:N.split(";").filter(u=>u.trim()))||[],o=((k=g.find(u=>u.id===t.label))==null?void 0:k.label)||t.uri,r=new URL(t.thesaurus).searchParams.get("idt"),l=M.find(u=>u.idTheso===r);if(!l){console.error("Thesaurus not found :",t);return}const a=(O=l==null?void 0:l.labels.find(u=>u.lang==="fr"))==null?void 0:O.title,c=document.createElement("li");c.className="indexation-type-item";const m=document.createElement("div");m.className="indexation-type-line";const I=document.createElement("span");I.className="indexation-type-label",I.textContent=o+" ("+(a||"Thésaurus non trouvé")+")",m.appendChild(I);const h=document.createElement("a");h.href=t.thesaurus,h.target="_blank",h.rel="noopener",h.className="thesaurus-link",h.style.marginLeft="8px",h.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',m.appendChild(h),c.appendChild(m);const R=document.createElement("div");R.className="indexation-concept-line";const w=document.createElement("ul");w.className="indexation-concepts-list",n.forEach((u,q)=>{w.appendChild(he(s,t,u,q))});const x=document.createElement("li");x.className="indexation-concept-item controls-item",!!d&&d.idTheso===r?x.appendChild(pe()):x.appendChild(ue(l,t)),w.appendChild(x),R.appendChild(w),c.appendChild(R),e.appendChild(c)}),j.replaceChildren(e)},ue=(e,t)=>{const n=document.createElement("button");return n.className="indexation-add-btn add-btn",n.title="Sélectionner ce thésaurus",n.textContent="+",n.onclick=s=>{s.stopPropagation(),Ue(t,e)},n},pe=()=>{const e=document.createElement("input");return e.type="search",e.placeholder="Rechercher un concept...",e.className="indexation-search",e.onkeydown=t=>Pe(t,e.value),setTimeout(()=>e.focus(),0),e},he=(e,t,n,s)=>{const o=e[s]||n,r=document.createElement("li");r.className="indexation-concept-item";const l=document.createElement("span");l.className="indexation-concept-label",l.textContent=o,r.appendChild(l);const a=document.createElement("a");a.href=n,a.target="_blank",a.rel="noopener",a.className="indexation-concept-link",a.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',r.appendChild(a);const c=document.createElement("button");return c.title="Supprimer",c.className="indexation-concept-delete",c.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',c.onclick=()=>ke(n,s,t.uri,t.label),r.appendChild(c),r},me=()=>{var s;const e=document.createElement("span"),t=document.createElement("span");t.textContent=`${((s=d.labels.find(o=>o.lang==="fr"))==null?void 0:s.title)||d.idTheso}`,e.appendChild(t);const n=document.createElement("a");n.href=`https://opentheso.huma-num.fr/?idt=${d.idTheso}`,n.target="_blank",n.rel="noopener",n.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',e.appendChild(n),ee.innerHTML=e.innerHTML},ge=()=>{C.innerHTML="Recherche..."},fe=e=>{C.innerHTML=e},H=()=>{if(!Array.isArray(L)||L.length===0){C.innerHTML="Aucun résultat.";return}const e=document.createElement("ul");e.className="search-results-list",e.style.listStyle="none",e.style.padding="0",e.style.margin="0",L.forEach(t=>{e.appendChild(be(t))}),C.innerHTML="",C.appendChild(e)},be=e=>{const t=document.createElement("li");t.className="search-result-item",t.style.padding="8px",t.style.borderBottom="1px solid #e0e0e0",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="flex-start",t.style.gap="8px";const n=ye(e),s=Ce(e),o=document.createElement("div");if(o.style.flexShrink="0",Te(s)){const c=document.createElement("span");c.textContent="✓",c.style.color="#1DA270",c.style.fontSize="1.2em",c.style.fontWeight="bold",o.appendChild(c)}else{const c=document.createElement("button");c.textContent="+",c.className="add-btn",c.style.padding="4px 8px",c.style.cursor="pointer",c.title="Ajouter ce concept",c.onclick=m=>{m.stopPropagation(),Oe(s,n,T.uri,T.label)},o.appendChild(c)}t.appendChild(o);const l=document.createElement("div");l.style.flex="1",l.style.minWidth="0";const a=document.createElement("span");return a.textContent=n,a.style.cursor="pointer",e.broaderLabel&&(a.title=`Terme plus générique: ${e.broaderLabel}`,a.style.textDecoration="underline",a.style.textDecorationStyle="dotted"),l.appendChild(a),t.appendChild(l),t},ye=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(s=>s["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},Ce=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),Te=e=>{var n;return!T||!i?!1:(((n=i[T.uri])==null?void 0:n.split(";").filter(s=>s.trim()))||[]).some(s=>s.trim()===e)},_=()=>{if(!i){ae();return}ie(),de(),H()},we=(e,t,n)=>{const s=i[t].split(";");s.splice(e,1);const o=s.join(";"),r=i[n].split(";");r.splice(e,1);const l=r.join(";");B({[t]:o,[n]:l},{id:i.id})},xe=(e,t,n,s)=>{B({[n]:i[n]+";"+e,[s]:i[s]+";"+t},{id:i.id})},Le=async()=>await(await fetch(v+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),Ee=async(e,t)=>await(await fetch(v+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),Ie=async(e,t)=>await(await fetch(v+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),Re=e=>{var n,s;const t=(s=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:s["@id"];if(!t)return null;try{const o=new URL(t,window.location.origin);return new URLSearchParams(o.search).get("idc")||null}catch{return null}},Se=async()=>{try{Le().then(e=>Fe(e))}catch(e){console.error(e)}},ve=()=>{me(),$()},Ae=async e=>{if(e.trim()){ge();try{const t=await Ee(d.idTheso,e);await Promise.all(t.map(async n=>{const s=Re(n);return s&&(n.broaderLabel=(await Ie(d.idTheso,s)).label),n})),je(t)}catch(t){let n;i?d&&d.idTheso?(n="Erreur lors de la recherche dans le thésaurus.",console.error(n,d.idTheso,t)):(n="Veuillez d'abord sélectionner un thésaurus.",console.error(n)):(n="Veuillez d'abord sélectionner une ressource.",console.error(n,d.idTheso,t)),fe(n)}}},$=()=>{H()},Ne=e=>{console.log("New record selected:",e),Q(e),_()},ke=(e,t,n,s)=>{console.log("Removing concept: ",e),we(t,n,s)},Oe=(e,t,n,s)=>{console.log("Add concept to column",n,e,t),xe(e,t,n,s)},Me=async()=>{Se(),grist.ready({requiredAccess:"full"}),V(await grist.getTable()),J(await oe(S)),W(await grist.docApi.fetchTable("CONFIG")),G(ce()),le(),grist.onRecord(e=>{Ne(e)})},Ue=(e,t)=>{console.log("Indexation type chosen:",e),Y(e),D(t),U([]),ve(),_()},Pe=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&Ae(t)},Fe=e=>{console.log("Thesauri fetched used to display thesauri labels :",e),X(e)},je=e=>{console.log("Concepts fetched with search:",e),U(e),$()},Be=async()=>{z(),Me()};Be();
