(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const V=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let O,F,L,I,b,i,d,x,f;const K=e=>{f=e},W=e=>{d=e},D=e=>{x=e},X=e=>{O=e},J=e=>{F=e},Q=e=>{I=e},Y=e=>{b=e},Z=e=>{i=e},P="UUID",k="https://opentheso.huma-num.fr/openapi",ee=(e,t)=>{for(var n=[],o=-1;(o=t.indexOf(e,o+1))>=0;)n.push(o);return n};function l(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const _=l("selectedResourceLabel"),p=l("configWarning"),H=l("existingIndexationsList"),te=l("sidebar"),$=l("openSidebarBtn");l("selectedThesaurusLabel");l("thesaurusLink");const N=l("searchInput"),ne=l("searchBtn"),y=l("searchResults"),se=()=>{p.textContent=`Veuillez créer une colonne qui s'appelle ${P} et qui contient l'uuid de la resource indexée.`,p.style.display="block"},oe=(e,t)=>{p.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,p.style.display="block"},re=()=>{p.textContent="",p.style.display="none"},ce=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await ae(e,t);console.log("currentTableColumnsIds : ",n);const o=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",o),n.filter(s=>o.includes(t.colId[s])).map(s=>({id:t.colId[s],label:t.label[s]}))},ae=async(e,t)=>{D(await e.getTableId()),console.log("technicalTableId : ",x);const n=await grist.docApi.fetchTable("_grist_Tables"),o=n.tableId.indexOf(x),s=n.id[o];console.log("gristTableId : ",s);const r=[];let c=t.parentId.indexOf(s);for(;c!==-1;)r.push(c),c=t.parentId.indexOf(s,c+1);return r},le=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",f),console.log("currentTableFormattedColumns : ",b);const e=f.filter(n=>!b.some(o=>o.id===n.uri)),t=f.filter(n=>!b.some(o=>o.id===n.label));b.map(n=>n.id).includes(P)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),oe(e,t)):re():(console.warn("Resource URI column is missing, this will cause issues."),se())},ie=()=>ee(x,d.table).map(t=>({id:d.id[t],manualSort:d.manualSort[t],table:d.table[t],uri:d.uri[t],thesaurus:d.thesaurus[t],label:d.label[t]})),de=(e,t)=>{console.log("Upserting Grist record with fields:",e),O.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},ue=()=>{_.textContent="Pas de ressource sélectionnée",H.innerHTML=""},he=()=>{_.textContent=i.UUID||""},pe=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",f.forEach(t=>{var M,A,U;const n=((M=i[t.uri])==null?void 0:M.split(";").filter(a=>a.trim()))||[],o=((A=i[t.label])==null?void 0:A.split(";").filter(a=>a.trim()))||[],s=new URL(t.thesaurus).searchParams.get("idt"),r=F.find(a=>a.idTheso===s),c=(U=r==null?void 0:r.labels.find(a=>a.lang==="fr"))==null?void 0:U.title,C=document.createElement("li");C.className="indexation-type-item";const w=document.createElement("div");w.className="indexation-type-line";const E=document.createElement("span");E.className="indexation-type-label",E.textContent=t.label+(c||"Thésaurus non trouvé"),w.appendChild(E);const u=document.createElement("a");u.href=t.thesaurus,u.target="_blank",u.rel="noopener",u.className="thesaurus-link",u.style.marginLeft="8px",u.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',w.appendChild(u),C.appendChild(w);const T=document.createElement("div");T.className="indexation-concept-line",n.forEach((a,R)=>{const G=o[R]||a;console.log("afficher concept: "+a);const m=document.createElement("span");m.className="indexation-concept";const v=document.createElement("span");v.className="indexation-concept-label",v.textContent=G,m.appendChild(v);const h=document.createElement("a");h.href=a,h.target="_blank",h.rel="noopener",h.className="indexation-concept-link",h.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',m.appendChild(h);const g=document.createElement("button");if(g.title="Supprimer",g.className="indexation-concept-delete",g.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',g.onclick=()=>Se(a,R,t.uri,t.label),m.appendChild(g),T.appendChild(m),R<n.length-1){const S=document.createElement("span");S.className="indexation-concept-separator",S.textContent=" ; ",T.appendChild(S)}}),C.appendChild(T),e.appendChild(C)}),H.replaceChildren(e)},j=e=>{var n,o;const t=(o=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:o["@id"];if(!t)return null;try{const s=new URL(t,window.location.origin);return new URLSearchParams(s.search).get("idc")||null}catch{return null}},me=()=>{y.innerHTML="Recherche..."},ge=e=>{y.innerHTML=e},q=()=>{if(!Array.isArray(I)||I.length===0){y.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&I.forEach(n=>{t.appendChild(be(n))}),y.innerHTML="",y.appendChild(e)},be=e=>{const t=document.createElement("tr");fe(e);const n=j(e);ye(e);let o=L.idTheso;const s=document.createElement("td");return s.className="broader-cell",s.textContent=n?"Chargement...":"",t.appendChild(s),e.broaderLabel?s.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${o}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:s.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${o}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},fe=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(o=>o["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},ye=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),Ce=()=>{if(!i){ue();return}he(),pe(),q()},we=(e,t,n)=>{const o=i[t].split(";");o.splice(e,1);const s=o.join(";"),r=i[n].split(";");r.splice(e,1);const c=r.join(";");de({[t]:s,[n]:c},{id:i.id})},Te=async()=>await(await fetch(k+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),Le=async(e,t)=>await(await fetch(k+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),Ie=async(e,t)=>await(await fetch(k+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),xe=()=>{B(),$.addEventListener("click",B),ne.addEventListener("click",()=>Oe(N.value)),N.addEventListener("keydown",e=>{ke(e,N.value)})},B=()=>{te.classList.remove("closed"),$.style.display="none"},Ee=async()=>{try{xe(),Te().then(e=>Me(e))}catch(e){console.error(e)}},z=async e=>{if(e.trim()){me();try{const t=await Le(L.idTheso,e);await Promise.all(t.map(async n=>{const o=j(n);return o&&(n.broaderLabel=(await Ie(L.idTheso,o)).label),n})),Ae(t)}catch(t){let n;i?(n="Veuillez d'abord sélectionner un thésaurus.",console.error(n)):(n="Veuillez d'abord sélectionner une ressource.",console.error(n,L.idTheso,t)),ge(n)}}},Re=()=>{q()},ve=e=>{console.log("New record selected:",e),Z(e),Ce()},Se=(e,t,n,o)=>{console.log("Removing concept: ",e),we(t,n,o)},Ne=async()=>{Ee(),grist.ready({requiredAccess:"full"}),X(await grist.getTable()),Y(await ce(O)),W(await grist.docApi.fetchTable("CONFIG")),K(ie()),le(),grist.onRecord(e=>{ve(e)})},Oe=e=>{console.log("Searching concepts with query:",e),z(e)},ke=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&z(t)},Me=e=>{console.log("Thesauri fetched used to display thesauri labels :",e),J(e)},Ae=e=>{console.log("Concepts fetched with search:",e),Q(e),Re()},Ue=async()=>{V(),Ne()};Ue();
