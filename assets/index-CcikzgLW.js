(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const D=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let O,M,a,C,w,d,u,L,m;const W=e=>{m=e},X=e=>{u=e},J=e=>{L=e},Q=e=>{O=e},Y=e=>{M=e},Z=e=>{a=e},ee=e=>{C=e},te=e=>{w=e},ne=e=>{d=e},_="UUID",A="https://opentheso.huma-num.fr/openapi",se=(e,t)=>{for(var n=[],o=-1;(o=t.indexOf(e,o+1))>=0;)n.push(o);return n};function c(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const $=c("selectedResourceLabel"),g=c("configWarning"),P=c("existingIndexationsList"),j=c("sidebar"),U=c("openSidebarBtn"),B=c("selectOtherThesaurusBtn"),N=c("thesaurusList"),oe=c("selectedThesaurusLabel"),R=c("thesaurusLink"),S=c("searchInput"),re=c("searchBtn"),le=c("filterInput"),y=c("searchResults"),ce=()=>{g.textContent=`Veuillez créer une colonne qui s'appelle ${_} et qui contient l'uuid de la resource indexée.`,g.style.display="block"},ae=(e,t)=>{g.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,g.style.display="block"},ie=()=>{g.textContent="",g.style.display="none"},de=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await ue(e,t);console.log("currentTableColumnsIds : ",n);const o=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",o),n.filter(s=>o.includes(t.colId[s])).map(s=>({id:t.colId[s],label:t.label[s]}))},ue=async(e,t)=>{J(await e.getTableId()),console.log("technicalTableId : ",L);const n=await grist.docApi.fetchTable("_grist_Tables"),o=n.tableId.indexOf(L),s=n.id[o];console.log("gristTableId : ",s);const r=[];let l=t.parentId.indexOf(s);for(;l!==-1;)r.push(l),l=t.parentId.indexOf(s,l+1);return r},he=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",m);const e=m.filter(n=>!w.some(o=>o.id===n.uri)),t=m.filter(n=>!w.some(o=>o.label===n.label));w.map(n=>n.id).includes(_)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),ae(e,t)):ie():(console.warn("Resource URI column is missing, this will cause issues."),ce())},pe=()=>se(L,u.table).map(t=>({id:u.id[t],manualSort:u.manualSort[t],table:u.table[t],uri:u.uri[t],thesaurus:u.thesaurus[t],label:u.label[t]})),me=(e,t)=>{console.log("Upserting Grist record with fields:",e),O.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},ge=()=>{$.textContent="Pas de ressource sélectionnée",P.innerHTML=""},fe=()=>{$.textContent=d.UUID||""},be=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",m.forEach(t=>{var F,H;const n=((F=d[t.uri])==null?void 0:F.split(";").filter(i=>i.trim()))||[],o=((H=d[t.label])==null?void 0:H.split(";").filter(i=>i.trim()))||[],s=m.find(i=>i.uri===t.uri),r=document.createElement("li");r.className="indexation-type-item";const l=document.createElement("div");l.className="indexation-type-line";const I=document.createElement("span");I.className="indexation-type-label",I.textContent=t.label+("Thésaurus : "+((s==null?void 0:s.thesaurus)||"Non spécifié")),l.appendChild(I);const h=document.createElement("a");h.href=(s==null?void 0:s.thesaurus)||"#",h.target="_blank",h.rel="noopener",h.className="thesaurus-link",h.style.marginLeft="8px",h.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',l.appendChild(h),r.appendChild(l);const T=document.createElement("div");T.className="indexation-concept-line",n.forEach((i,x)=>{const K=o[x]||i;console.log("afficher concept: "+i);const f=document.createElement("span");f.className="indexation-concept";const E=document.createElement("span");E.className="indexation-concept-label",E.textContent=K,f.appendChild(E);const p=document.createElement("a");p.href=i,p.target="_blank",p.rel="noopener",p.className="indexation-concept-link",p.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',f.appendChild(p);const b=document.createElement("button");if(b.title="Supprimer",b.className="indexation-concept-delete",b.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',b.onclick=()=>He(i,x,t.uri,t.label),f.appendChild(b),T.appendChild(f),x<n.length-1){const v=document.createElement("span");v.className="indexation-concept-separator",v.textContent=" ; ",T.appendChild(v)}}),r.appendChild(T),e.appendChild(r)}),P.appendChild(e)},q=e=>{var n,o;const t=(o=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:o["@id"];if(!t)return null;try{const s=new URL(t,window.location.origin);return new URLSearchParams(s.search).get("idc")||null}catch{return null}},ye=()=>{y.innerHTML="Recherche..."},Te=e=>{y.innerHTML=e},z=()=>{if(!Array.isArray(C)||C.length===0){y.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&C.forEach(n=>{t.appendChild(Ce(n))}),y.innerHTML="",y.appendChild(e)},Ce=e=>{const t=document.createElement("tr"),n=we(e),o=q(e),s=Le(e);let r=a.idTheso;t.appendChild(getActionCellForConcept(s,n)),t.appendChild(getConceptLabelCell(s,n));const l=document.createElement("td");return l.className="broader-cell",l.textContent=o?"Chargement...":"",t.appendChild(l),e.broaderLabel?l.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${o}&idt=${r}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:l.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${o}&idt=${r}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},we=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(o=>o["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},Le=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),Ie=()=>{if(!d){ge();return}fe(),be(),z()},xe=(e,t,n)=>{const o=d[t].split(";");o.splice(e,1);const s=o.join(";"),r=d[n].split(";");r.splice(e,1);const l=r.join(";");me({[t]:s,[n]:l},{id:d.id})},Ee=async()=>await(await fetch(A+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),ve=async(e,t)=>await(await fetch(A+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),Re=async(e,t)=>await(await fetch(A+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),Se=()=>{N.innerText="Erreur de chargement."},ke=()=>{k(),U.addEventListener("click",k),B.addEventListener("click",k),re.addEventListener("click",()=>Pe(S.value)),S.addEventListener("keydown",e=>{je(e,S.value)}),le.addEventListener("input",function(){const e=this.value.toLowerCase(),t=M.filter(n=>{var o,s;return(((s=(o=n.labels)==null?void 0:o.find(r=>r.lang==="fr"))==null?void 0:s.title)||"").toLowerCase().includes(e)});G(t)})},G=e=>{N.innerHTML="",e.forEach(t=>{var o,s;const n=document.createElement("div");n.className="thesaurus-item",n.textContent=((s=(o=t.labels)==null?void 0:o.find(r=>r.lang==="fr"))==null?void 0:s.title)||t.idTheso,n.onclick=()=>$e(t),N.appendChild(n)})},Ne=()=>{var t,n;const e=((n=(t=a.labels)==null?void 0:t.find(o=>o.lang==="fr"))==null?void 0:n.title)||a.idTheso;oe.textContent=e,a.idTheso?(R.href=`https://opentheso.huma-num.fr/opentheso/?idt=${encodeURIComponent(a.idTheso)}`,R.style.display="inline-block"):R.style.display="none"},Oe=()=>{j.classList.add("closed"),U.style.display="block",B.style.display="block"},k=()=>{j.classList.remove("closed"),U.style.display="none",B.style.display="none"},Me=async()=>{try{ke(),Ee().then(e=>qe(e))}catch(e){Se(),console.error(e)}},Ae=()=>{G(M)},Ue=()=>{Ne(),Oe()},V=async e=>{if(e.trim()){ye();try{const t=await ve(a.idTheso,e);await Promise.all(t.map(async n=>{const o=q(n);return o&&(n.broaderLabel=(await Re(a.idTheso,o)).label),n})),ze(t)}catch(t){let n;d?a&&a.idTheso?(n="Erreur lors de la recherche dans le thésaurus.",console.error(n,a.idTheso,t)):(n="Veuillez d'abord sélectionner un thésaurus.",console.error(n)):(n="Veuillez d'abord sélectionner une ressource.",console.error(n,a.idTheso,t)),Te(n)}}},Be=()=>{z()},Fe=e=>{console.log("New record selected:",e),ne(e),Ie()},He=(e,t,n,o)=>{console.log("Removing concept: ",e),xe(t,n,o)},_e=async()=>{Me(),grist.ready({requiredAccess:"full"}),Q(await grist.getTable()),te(await de(O)),X(await grist.docApi.fetchTable("CONFIG")),W(pe()),he(),grist.onRecord(e=>{Fe(e)})},$e=e=>{console.log("Thesaurus selected:",e),Z(e),Ue()},Pe=e=>{console.log("Searching concepts with query:",e),V(e)},je=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&V(t)},qe=e=>{console.log("Thesauri fetched:",e),Y(e),Ae()},ze=e=>{console.log("Concepts fetched with search:",e),ee(e),Be()},Ge=async()=>{D(),_e()};Ge();
