(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(s){if(s.ep)return;s.ep=!0;const l=n(s);fetch(s.href,l)}})();const j=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v2.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let i,O,v,d,b,p,f;const B=e=>{i=e},z=e=>{O=e},q=e=>{v=e},G=e=>{d=e},D=e=>{b=e},V=e=>{p=e},W=e=>{f=e},u="_prefLabel",E="CONFIG_OPENTHESO",x="UUID",N="https://opentheso.huma-num.fr/openapi";function a(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const R=a("selectedResourceLabel"),h=a("configWarning"),C=a("existingIndexationsList"),M=a("sidebar"),S=a("openSidebarBtn"),_=a("selectOtherThesaurusBtn"),I=a("thesaurusList"),K=a("selectedThesaurusLabel"),T=a("thesaurusLink"),L=a("searchInput"),J=a("searchBtn"),X=a("filterInput"),g=a("searchResults"),Q=()=>{h.textContent=`Veuillez créer une colonne qui s'appelle ${E}.`,h.style.display="block"},Y=()=>{h.textContent=`Veuillez créer une colonne qui s'appelle ${x} et qui contient l'uuid de la resource indexée.`,h.style.display="block"},Z=e=>{h.innerHTML=`Les colonnes suivantes n'ont pas de colonne de labels associée (suffixe ${u}) : <strong>${e.map(t=>t.label).join(", ")}</strong>.<br/>Veuillez créer les colonnes de labels associées.`,h.style.display="block"},ee=()=>{h.textContent="",h.style.display="none"},te=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await ne(e,t);console.log("currentTableColumnsIds : ",n);const o=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",o),n.filter(s=>o.includes(t.colId[s])).map(s=>({id:t.colId[s],label:t.label[s]}))},ne=async(e,t)=>{const n=await e.getTableId();console.log("technicalTableId : ",n);const o=await grist.docApi.fetchTable("_grist_Tables"),s=o.tableId.indexOf(n),l=o.id[s];console.log("gristTableId : ",l);const r=[];let c=t.parentId.indexOf(l);for(;c!==-1;)r.push(c),c=t.parentId.indexOf(l,c+1);return r},se=()=>{const e=p.filter(t=>!t.id.endsWith(u)&&t.id!==E&&t.id!==x&&p.filter(n=>n.id===t.id+u).length===0);p.map(t=>t.id).includes(E)?p.map(t=>t.id).includes(x)?e.length?(console.warn("Some columns are missing their label display column, this will cause issues.",e),Z(e)):ee():(console.warn("Resource URI column is missing, this will cause issues."),Y()):(console.warn("Configuration column is missing, this will cause issues."),Q())},oe=(e,t)=>{console.log("Upserting Grist record with fields:",e),O.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},le=()=>{R.textContent="Pas de ressource sélectionnée",C.innerHTML=""},re=()=>{R.textContent=f.UUID||""},ce=()=>{C.innerHTML="<div style='font-size:0.95em;'>Aucune indexation existante.</div>"},ie=()=>{C.innerHTML="<h3 style='font-size:1em;margin-bottom:6px;'>Liste des indexations existantes</h3>";const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",Object.entries(i).forEach(([t,n])=>{!Array.isArray(n)||n.length===0||e.appendChild(ae(t,n))}),C.appendChild(e)},ae=(e,t)=>{const n=p.find(m=>m.id===e+u),o=n?n.label:e,s=document.createElement("li");s.className="indexation-type-item";const l=document.createElement("div");l.className="indexation-type-line";const r=document.createElement("span");r.className="indexation-type-label",r.textContent=o+" :",l.appendChild(r);const c=document.createElement("div");return c.className="indexation-concept-line",l.appendChild(c),t.forEach((m,$)=>{const P=de(e,m);if(c.appendChild(P),$<t.length-1){const y=document.createElement("span");y.className="indexation-concept-separator",y.textContent=" ; ",c.appendChild(y)}}),s.appendChild(l),s};function de(e,t){const n=document.createElement("span");n.className="indexation-concept";const o=document.createElement("span");o.className="indexation-concept-label",o.textContent=t.label_concept;const s=document.createElement("a");s.href=t.uri_concept,s.target="_blank",s.rel="noopener",s.className="indexation-concept-link",s.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" />';const l=document.createElement("button");return l.title="Supprimer",l.className="indexation-concept-delete",l.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',l.onclick=()=>He(t.uri_concept,e),n.appendChild(o),n.appendChild(s),n.appendChild(l),n}const k=e=>{var n,o;const t=(o=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:o["@id"];if(!t)return null;try{const s=new URL(t,window.location.origin);return new URLSearchParams(s.search).get("idc")||null}catch{return null}},ue=()=>{g.innerHTML="Recherche..."},pe=e=>{g.innerHTML=e},A=()=>{if(!Array.isArray(b)||b.length===0){g.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&b.forEach(n=>{t.appendChild(he(n))}),g.innerHTML="",g.appendChild(e)},he=e=>{const t=document.createElement("tr"),n=me(e),o=k(e),s=ge(e);let l=d.idTheso;t.appendChild(ye(s,n)),t.appendChild(Te(s,n));const r=document.createElement("td");return r.className="broader-cell",r.textContent=o?"Chargement...":"",t.appendChild(r),e.broaderLabel?r.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${o}&idt=${l}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:r.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${o}&idt=${l}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},me=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(o=>o["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},ge=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),fe=e=>p.filter(t=>t.id.endsWith(u)).filter(t=>{var n;return!((n=i[t.id.replace(u,"")])!=null&&n.some(o=>o.uri_concept===e))}),be=e=>p.filter(t=>t.id.endsWith(u)).filter(t=>{var n;return(n=i[t.id.replace(u,"")])==null?void 0:n.some(o=>o.uri_concept===e)}),Ce=e=>{const t=document.createElement("option");return t.value=e.id,t.textContent=e.label,t},ye=(e,t)=>{const n=fe(e),o=be(e),s=document.createElement("select");s.className="concepts-select",s.innerHTML='<option value="">Sélectionner...</option>',n.forEach(m=>{s.appendChild(Ce(m))}),s.addEventListener("change",()=>{Ue(e,t,s.value)});const l=o.length>1?"s":"",r=document.createElement("div");r.className="concepts-info",r.textContent=`${o.length} colonne${l} sélectionnée${l}.`;const c=document.createElement("td");return c.className="concepts-action-cell",c.appendChild(s),c.appendChild(r),c},Te=(e,t)=>{const n=document.createElement("td");return n.className="concepts-label-cell",n.innerHTML=`${t} <a href="${e}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,n},Le=()=>{if(!f){le();return}if(re(),!Object.keys(i).length){ce();return}ie(),A()},we=(e,t)=>{const n=t.replace(u,"");i[n]=i[n].filter(o=>o.uri_concept!==e),F(i)},Ee=(e,t,n)=>{const o=n.replace(u,"");Array.isArray(i[o])||(i[o]=[]),i[o].some(s=>s.uri_concept===e)||i[o].push({uri_concept:e,label_concept:t}),F(i)},F=e=>{const t={};for(const[n,o]of Object.entries(e))t[n]=(o||[]).map(s=>s.uri_concept).join(" ; "),t[n+u]=(o||[]).map(s=>s.label_concept).join(" ; ");oe({CONFIG_OPENTHESO:JSON.stringify(e),...t},{id:f.id})},xe=async()=>await(await fetch(N+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),Ie=async(e,t)=>await(await fetch(N+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),Oe=async(e,t)=>await(await fetch(N+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),ve=()=>{I.innerText="Erreur de chargement."},Ne=()=>{w(),S.addEventListener("click",w),_.addEventListener("click",w),J.addEventListener("click",()=>je(L.value)),L.addEventListener("keydown",e=>{Be(e,L.value)}),X.addEventListener("input",function(){const e=this.value.toLowerCase(),t=v.filter(n=>{var o,s;return(((s=(o=n.labels)==null?void 0:o.find(l=>l.lang==="fr"))==null?void 0:s.title)||"").toLowerCase().includes(e)});H(t)})},H=e=>{I.innerHTML="",e.forEach(t=>{var o,s;const n=document.createElement("div");n.className="thesaurus-item",n.textContent=((s=(o=t.labels)==null?void 0:o.find(l=>l.lang==="fr"))==null?void 0:s.title)||t.idTheso,n.onclick=()=>Pe(t),I.appendChild(n)})},Se=()=>{var t,n;const e=((n=(t=d.labels)==null?void 0:t.find(o=>o.lang==="fr"))==null?void 0:n.title)||d.idTheso;K.textContent=e,d.idTheso?(T.href=`https://opentheso.huma-num.fr/opentheso/?idt=${encodeURIComponent(d.idTheso)}`,T.style.display="inline-block"):T.style.display="none"},_e=()=>{M.classList.add("closed"),S.style.display="block",_.style.display="block"},w=()=>{M.classList.remove("closed"),S.style.display="none",_.style.display="none"},Re=async()=>{try{Ne(),xe().then(e=>ze(e))}catch(e){ve(),console.error(e)}},Me=()=>{H(v)},ke=()=>{Se(),_e()},U=async e=>{if(e.trim()){ue();try{const t=await Ie(d.idTheso,e);await Promise.all(t.map(async n=>{const o=k(n);return o&&(n.broaderLabel=(await Oe(d.idTheso,o)).label),n})),qe(t)}catch(t){let n;f?d&&d.idTheso?(n="Erreur lors de la recherche dans le thésaurus.",console.error(n,d.idTheso,t)):(n="Veuillez d'abord sélectionner un thésaurus.",console.error(n)):(n="Veuillez d'abord sélectionner une ressource.",console.error(n,d.idTheso,t)),pe(n)}}},Ae=()=>{A()},Fe=e=>{console.log("New record selected:",e),W(e),B(e&&e.CONFIG_OPENTHESO?JSON.parse(e.CONFIG_OPENTHESO):{}),Le()},He=(e,t)=>{console.log("Removing concept from column:",e,t),we(e,t)},Ue=(e,t,n)=>{if(!n){alert("Veuillez sélectionner une colonne.");return}console.log("Add concept to column",n,e,t),Ee(e,t,n)},$e=async()=>{Re(),grist.ready({requiredAccess:"full"}),z(await grist.getTable()),V(await te(O)),se(),grist.onRecord(e=>{Fe(e)})},Pe=e=>{console.log("Thesaurus selected:",e),G(e),ke()},je=e=>{console.log("Searching concepts with query:",e),U(e)},Be=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&U(t)},ze=e=>{console.log("Thesauri fetched:",e),q(e),Me()},qe=e=>{console.log("Concepts fetched with search:",e),D(e),Ae()},Ge=async()=>{j(),$e()};Ge();
