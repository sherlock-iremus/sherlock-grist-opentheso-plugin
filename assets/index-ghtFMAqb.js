(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();const U=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let E,L,a,f,g,d,i,b,h;const $=e=>{h=e},F=e=>{i=e},N=e=>{b=e},P=e=>{E=e},B=e=>{L=e},_=e=>{a=e},H=e=>{f=e},j=e=>{g=e},q=e=>{d=e},S="UUID",w="https://opentheso.huma-num.fr/openapi",z=(e,t)=>{for(var s=[],n=-1;(n=t.indexOf(e,n+1))>=0;)s.push(n);return s};function c(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const v=c("selectedResourceLabel"),u=c("configWarning"),V=c("existingIndexationsList"),O=c("sidebar"),I=c("openSidebarBtn"),R=c("selectOtherThesaurusBtn"),C=c("thesaurusList"),G=c("selectedThesaurusLabel"),m=c("thesaurusLink"),T=c("searchInput"),K=c("searchBtn"),D=c("filterInput"),p=c("searchResults"),W=()=>{u.textContent=`Veuillez créer une colonne qui s'appelle ${S} et qui contient l'uuid de la resource indexée.`,u.style.display="block"},X=(e,t)=>{u.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(s=>s.label).join(", ")}<br/>URI : ${t.map(s=>s.uri).join(", ")}`,u.style.display="block"},J=()=>{u.textContent="",u.style.display="none"},Q=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const s=await Y(e,t);console.log("currentTableColumnsIds : ",s);const n=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",n),s.filter(o=>n.includes(t.colId[o])).map(o=>({id:t.colId[o],label:t.label[o]}))},Y=async(e,t)=>{N(await e.getTableId()),console.log("technicalTableId : ",b);const s=await grist.docApi.fetchTable("_grist_Tables"),n=s.tableId.indexOf(b),o=s.id[n];console.log("gristTableId : ",o);const r=[];let l=t.parentId.indexOf(o);for(;l!==-1;)r.push(l),l=t.parentId.indexOf(o,l+1);return r},Z=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",h);const e=h.filter(s=>!g.some(n=>n.id===s.uri)),t=h.filter(s=>!g.some(n=>n.label===s.label));g.map(s=>s.id).includes(S)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),X(e,t)):J():(console.warn("Resource URI column is missing, this will cause issues."),W())},ee=()=>z(b,i.table).map(t=>({id:i.id[t],manualSort:i.manualSort[t],table:i.table[t],uri:i.uri[t],thesaurus:i.thesaurus[t],label:i.label[t]})),te=()=>{v.textContent="Pas de ressource sélectionnée",V.innerHTML=""},se=()=>{v.textContent=d.UUID||""},ne=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",h.forEach(t=>{var s;console.log("afficher colonne "+t.label),console.log(d),console.log(d[t.id]),(s=d[t.id])==null||s.split(";").forEach((n,o)=>{console.log("afficher concept "+n)})})},x=e=>{var s,n;const t=(n=(s=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:s[0])==null?void 0:n["@id"];if(!t)return null;try{const o=new URL(t,window.location.origin);return new URLSearchParams(o.search).get("idc")||null}catch{return null}},oe=()=>{p.innerHTML="Recherche..."},re=e=>{p.innerHTML=e},M=()=>{if(!Array.isArray(f)||f.length===0){p.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&f.forEach(s=>{t.appendChild(le(s))}),p.innerHTML="",p.appendChild(e)},le=e=>{const t=document.createElement("tr"),s=ce(e),n=x(e),o=ae(e);let r=a.idTheso;t.appendChild(getActionCellForConcept(o,s)),t.appendChild(getConceptLabelCell(o,s));const l=document.createElement("td");return l.className="broader-cell",l.textContent=n?"Chargement...":"",t.appendChild(l),e.broaderLabel?l.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${r}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:l.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${r}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},ce=e=>{var t,s;return((s=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(n=>n["@language"]==="fr"))==null?void 0:s["@value"])||"(Sans label)"},ae=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),ie=()=>{if(!d){te();return}se(),ne(),M()},de=async()=>await(await fetch(w+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),ue=async(e,t)=>await(await fetch(w+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),he=async(e,t)=>await(await fetch(w+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),pe=()=>{C.innerText="Erreur de chargement."},fe=()=>{y(),I.addEventListener("click",y),R.addEventListener("click",y),K.addEventListener("click",()=>Re(T.value)),T.addEventListener("keydown",e=>{Ee(e,T.value)}),D.addEventListener("input",function(){const e=this.value.toLowerCase(),t=L.filter(s=>{var n,o;return(((o=(n=s.labels)==null?void 0:n.find(r=>r.lang==="fr"))==null?void 0:o.title)||"").toLowerCase().includes(e)});k(t)})},k=e=>{C.innerHTML="",e.forEach(t=>{var n,o;const s=document.createElement("div");s.className="thesaurus-item",s.textContent=((o=(n=t.labels)==null?void 0:n.find(r=>r.lang==="fr"))==null?void 0:o.title)||t.idTheso,s.onclick=()=>Ie(t),C.appendChild(s)})},ge=()=>{var t,s;const e=((s=(t=a.labels)==null?void 0:t.find(n=>n.lang==="fr"))==null?void 0:s.title)||a.idTheso;G.textContent=e,a.idTheso?(m.href=`https://opentheso.huma-num.fr/opentheso/?idt=${encodeURIComponent(a.idTheso)}`,m.style.display="inline-block"):m.style.display="none"},be=()=>{O.classList.add("closed"),I.style.display="block",R.style.display="block"},y=()=>{O.classList.remove("closed"),I.style.display="none",R.style.display="none"},me=async()=>{try{fe(),de().then(e=>Se(e))}catch(e){pe(),console.error(e)}},Te=()=>{k(L)},ye=()=>{ge(),be()},A=async e=>{if(e.trim()){oe();try{const t=await ue(a.idTheso,e);await Promise.all(t.map(async s=>{const n=x(s);return n&&(s.broaderLabel=(await he(a.idTheso,n)).label),s})),ve(t)}catch(t){let s;d?a&&a.idTheso?(s="Erreur lors de la recherche dans le thésaurus.",console.error(s,a.idTheso,t)):(s="Veuillez d'abord sélectionner un thésaurus.",console.error(s)):(s="Veuillez d'abord sélectionner une ressource.",console.error(s,a.idTheso,t)),re(s)}}},Ce=()=>{M()},Le=e=>{console.log("New record selected:",e),q(e),ie()},we=async()=>{me(),grist.ready({requiredAccess:"full"}),P(await grist.getTable()),j(await Q(E)),F(await grist.docApi.fetchTable("CONFIG")),$(ee()),Z(),grist.onRecord(e=>{Le(e)})},Ie=e=>{console.log("Thesaurus selected:",e),_(e),ye()},Re=e=>{console.log("Searching concepts with query:",e),A(e)},Ee=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&A(t)},Se=e=>{console.log("Thesauri fetched:",e),B(e),Te()},ve=e=>{console.log("Concepts fetched with search:",e),H(e),Ce()},Oe=async()=>{U(),we()};Oe();
