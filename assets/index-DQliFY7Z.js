(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(s){if(s.ep)return;s.ep=!0;const l=n(s);fetch(s.href,l)}})();const G=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let M,H,u,N,p,i,a,I,T;const z=e=>{T=e},K=e=>{a=e},W=e=>{I=e},V=e=>{M=e},X=e=>{H=e},P=e=>{u=e},J=e=>{p=e},Q=e=>{i=e},F="UUID",Y="https://opentheso.huma-num.fr/openapi",Z=(e,t)=>{for(var n=[],o=-1;(o=t.indexOf(e,o+1))>=0;)n.push(o);return n};function g(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const q=g("selectedResourceLabel"),m=g("configWarning"),$=g("existingIndexationsList"),D=g("selectedThesaurusLabel");g("thesaurusLink");const S=g("searchResults"),ee=()=>{m.textContent=`Veuillez créer une colonne qui s'appelle ${F} et qui contient l'uuid de la resource indexée.`,m.style.display="block"},te=(e,t)=>{m.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,m.style.display="block"},ne=()=>{m.textContent="",m.style.display="none"},se=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await oe(e,t);console.log("currentTableColumnsIds : ",n);const o=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",o),n.filter(s=>o.includes(t.colId[s])).map(s=>({id:t.colId[s],label:t.label[s]}))},oe=async(e,t)=>{W(await e.getTableId()),console.log("technicalTableId : ",I);const n=await grist.docApi.fetchTable("_grist_Tables"),o=n.tableId.indexOf(I),s=n.id[o];console.log("gristTableId : ",s);const l=[];let c=t.parentId.indexOf(s);for(;c!==-1;)l.push(c),c=t.parentId.indexOf(s,c+1);return l},re=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",T),console.log("currentTableFormattedColumns : ",p);const e=T.filter(n=>!p.some(o=>o.id===n.uri)),t=T.filter(n=>!p.some(o=>o.id===n.label));p.map(n=>n.id).includes(F)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),te(e,t)):ne():(console.warn("Resource URI column is missing, this will cause issues."),ee())},le=()=>Z(I,a.table).map(t=>({id:a.id[t],manualSort:a.manualSort[t],table:a.table[t],uri:a.uri[t],thesaurus:a.thesaurus[t],label:a.label[t]})),ce=(e,t)=>{console.log("Upserting Grist record with fields:",e),M.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},ae=()=>{q.textContent="Pas de ressource sélectionnée",$.innerHTML=""},ie=()=>{q.textContent=i.UUID||""},de=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",T.forEach(t=>{var O,k,A,U;const n=((O=i[t.uri])==null?void 0:O.split(";").filter(r=>r.trim()))||[],o=((k=i[t.label])==null?void 0:k.split(";").filter(r=>r.trim()))||[],s=((A=p.find(r=>r.id===t.label))==null?void 0:A.label)||t.uri,l=new URL(t.thesaurus).searchParams.get("idt"),c=H.find(r=>r.idTheso===l);if(!c){console.error("Thesaurus not found :",t);return}const B=(U=c==null?void 0:c.labels.find(r=>r.lang==="fr"))==null?void 0:U.title,b=document.createElement("li");b.className="indexation-type-item";const C=document.createElement("div");C.className="indexation-type-line";const E=document.createElement("span");E.className="indexation-type-label",E.textContent=s+"("+(B||"Thésaurus non trouvé")+")",C.appendChild(E);const d=document.createElement("a");d.href=t.thesaurus,d.target="_blank",d.rel="noopener",d.className="thesaurus-link",d.style.marginLeft="8px",d.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',C.appendChild(d),b.appendChild(C);const R=document.createElement("div");R.className="indexation-concept-line";const w=document.createElement("ul");w.className="indexation-concepts-list",n.forEach((r,x)=>{const j=o[x]||r,f=document.createElement("li");f.className="indexation-concept-item";const v=document.createElement("span");v.className="indexation-concept-label",v.textContent=j,f.appendChild(v);const h=document.createElement("a");h.href=r,h.target="_blank",h.rel="noopener",h.className="indexation-concept-link",h.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',f.appendChild(h);const y=document.createElement("button");y.title="Supprimer",y.className="indexation-concept-delete",y.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',y.onclick=()=>xe(r,x,t.uri,t.label),f.appendChild(y),w.appendChild(f)});const L=document.createElement("li");if(L.className="indexation-concept-item controls-item",!!u&&u.idTheso===l){const r=document.createElement("input");r.type="search",r.placeholder="Rechercher un concept...",r.className="indexation-search",L.appendChild(r)}else{const r=document.createElement("button");r.className="indexation-add-btn",r.title="Sélectionner ce thésaurus",r.textContent="+",r.onclick=x=>{x.stopPropagation(),P(c),_(t,c)},L.appendChild(r)}w.appendChild(L),R.appendChild(w),b.addEventListener("click",()=>{_(t,c)}),b.appendChild(R),e.appendChild(b)}),$.replaceChildren(e)},ue=e=>{var n,o;const t=(o=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:o["@id"];if(!t)return null;try{const s=new URL(t,window.location.origin);return new URLSearchParams(s.search).get("idc")||null}catch{return null}},he=()=>{var o;const e=document.createElement("span"),t=document.createElement("span");t.textContent=`${((o=u.labels.find(s=>s.lang==="fr"))==null?void 0:o.title)||u.idTheso}`,e.appendChild(t);const n=document.createElement("a");n.href=`https://opentheso.huma-num.fr/?idt=${u.idTheso}`,n.target="_blank",n.rel="noopener",n.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',e.appendChild(n),D.innerHTML=e.innerHTML},pe=()=>{if(!Array.isArray(N)||N.length===0){S.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&N.forEach(n=>{t.appendChild(me(n))}),S.innerHTML="",S.appendChild(e)},me=e=>{const t=document.createElement("tr");ge(e);const n=ue(e);be(e);let o=u.idTheso;const s=document.createElement("td");return s.className="broader-cell",s.textContent=n?"Chargement...":"",t.appendChild(s),e.broaderLabel?s.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${o}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:s.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${n}&idt=${o}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},ge=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(o=>o["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},be=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),fe=()=>{if(!i){ae();return}ie(),de(),pe()},ye=(e,t,n)=>{const o=i[t].split(";");o.splice(e,1);const s=o.join(";"),l=i[n].split(";");l.splice(e,1);const c=l.join(";");ce({[t]:s,[n]:c},{id:i.id})},Te=async()=>await(await fetch(Y+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),Ce=async()=>{try{Te().then(e=>Ee(e))}catch(e){console.error(e)}},we=()=>{he()},Le=e=>{console.log("New record selected:",e),Q(e),fe()},xe=(e,t,n,o)=>{console.log("Removing concept: ",e),ye(t,n,o)},Ie=async()=>{Ce(),grist.ready({requiredAccess:"full"}),V(await grist.getTable()),J(await se(M)),K(await grist.docApi.fetchTable("CONFIG")),z(le()),re(),grist.onRecord(e=>{Le(e)})},_=(e,t)=>{console.log("Indexation type chosen:",e),P(t),we()},Ee=e=>{console.log("Thesauri fetched used to display thesauri labels :",e),X(e)},Re=async()=>{G(),Ie()};Re();
