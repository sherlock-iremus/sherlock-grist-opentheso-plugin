(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const J=()=>{console.log(`                                      
 ▗▄▖ ▗▖ ▗▖▗▄▄▄▖▗▄▄▖ ▗▖    ▗▄▖   ▄▄ ▗▖ ▄▖
▗▛▀▜ ▐▌ ▐▌▐▛▀▀▘▐▛▀▜▌▐▌    █▀█  █▀▀▌▐▌▐▛ 
▐▙   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌   ▐▌ ▐▌▐▛   ▐▙█  
 ▜█▙ ▐███▌▐███ ▐███ ▐▌   ▐▌ ▐▌▐▌   ▐██  
   ▜▌▐▌ ▐▌▐▌   ▐▌▝█▖▐▌   ▐▌ ▐▌▐▙   ▐▌▐▙ 
▐▄▄▟▘▐▌ ▐▌▐▙▄▄▖▐▌ ▐▌▐▙▄▄▖ █▄█  █▄▄▌▐▌ █▖
 ▀▀▘ ▝▘ ▝▘▝▀▀▀▘▝▘ ▝▀▝▀▀▀▘ ▝▀▘   ▀▀ ▝▘ ▝▘
                                        
Grist X Opentheso Plugin - v3.0.0
Please visit for technical documentation https://github.com/sherlock-iremus/ `)};let U,x,i,L,I,d,u,E,b;const Q=e=>{b=e},Y=e=>{u=e},Z=e=>{E=e},ee=e=>{U=e},te=e=>{x=e},ne=e=>{i=e},se=e=>{L=e},oe=e=>{I=e},re=e=>{d=e},j="UUID",B="https://opentheso.huma-num.fr/openapi",le=(e,t)=>{for(var n=[],s=-1;(s=t.indexOf(e,s+1))>=0;)n.push(s);return n};function c(e){const t=document.getElementById(e);if(!t)throw new Error(`Element with id "${e}" not found`);return t}const q=c("selectedResourceLabel"),m=c("configWarning"),z=c("existingIndexationsList"),G=c("sidebar"),F=c("openSidebarBtn"),H=c("selectOtherThesaurusBtn"),A=c("thesaurusList"),ce=c("selectedThesaurusLabel"),N=c("thesaurusLink"),O=c("searchInput"),ae=c("searchBtn"),ie=c("filterInput"),y=c("searchResults"),de=()=>{m.textContent=`Veuillez créer une colonne qui s'appelle ${j} et qui contient l'uuid de la resource indexée.`,m.style.display="block"},ue=(e,t)=>{m.innerHTML=`Les colonnes suivantes sont configurées mais non crées. <br/>Label : ${e.map(n=>n.label).join(", ")}<br/>URI : ${t.map(n=>n.uri).join(", ")}`,m.style.display="block"},he=()=>{m.textContent="",m.style.display="none"},pe=async e=>{const t=await grist.docApi.fetchTable("_grist_Tables_column");console.log("gristTableColumns : ",t);const n=await me(e,t);console.log("currentTableColumnsIds : ",n);const s=Object.keys(await grist.fetchSelectedTable({format:"columns"}));return console.log("directlyFetchedTableColumns : ",s),n.filter(o=>s.includes(t.colId[o])).map(o=>({id:t.colId[o],label:t.label[o]}))},me=async(e,t)=>{Z(await e.getTableId()),console.log("technicalTableId : ",E);const n=await grist.docApi.fetchTable("_grist_Tables"),s=n.tableId.indexOf(E),o=n.id[s];console.log("gristTableId : ",o);const r=[];let l=t.parentId.indexOf(o);for(;l!==-1;)r.push(l),l=t.parentId.indexOf(o,l+1);return r},ge=()=>{console.log("Checking for missing configuration columns..."),console.log("configTableRecords : ",b);const e=b.filter(n=>!I.some(s=>s.id===n.uri)),t=b.filter(n=>!I.some(s=>s.label===n.label));I.map(n=>n.id).includes(j)?e.length||t.length?(console.warn("Some URI | label columns are missing : ",e,t),ue(e,t)):he():(console.warn("Resource URI column is missing, this will cause issues."),de())},fe=()=>le(E,u.table).map(t=>({id:u.id[t],manualSort:u.manualSort[t],table:u.table[t],uri:u.uri[t],thesaurus:u.thesaurus[t],label:u.label[t]})),be=(e,t)=>{console.log("Upserting Grist record with fields:",e),U.upsert({fields:e,require:t}).then(n=>console.log(n)).catch(n=>console.log(n))},ye=()=>{q.textContent="Pas de ressource sélectionnée",z.innerHTML=""},Te=()=>{q.textContent=d.UUID||""},Ce=()=>{const e=document.createElement("ul");e.style.paddingLeft="1.2em",e.style.margin="0",b.forEach(t=>{var P,_,$;const n=((P=d[t.uri])==null?void 0:P.split(";").filter(a=>a.trim()))||[],s=((_=d[t.label])==null?void 0:_.split(";").filter(a=>a.trim()))||[],o=new URL(t.thesaurus).searchParams.get("idt"),r=x.find(a=>a.idTheso===o),l=($=r==null?void 0:r.labels.find(a=>a.lang==="fr"))==null?void 0:$.title,T=document.createElement("li");T.className="indexation-type-item";const C=document.createElement("div");C.className="indexation-type-line";const v=document.createElement("span");v.className="indexation-type-label",v.textContent=t.label+("Thésaurus : "+(l||"Non spécifié")),C.appendChild(v);const h=document.createElement("a");h.href=t.thesaurus,h.target="_blank",h.rel="noopener",h.className="thesaurus-link",h.style.marginLeft="8px",h.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir thésaurus" style="width:14px;height:14px;" />',C.appendChild(h),T.appendChild(C);const w=document.createElement("div");w.className="indexation-concept-line",n.forEach((a,R)=>{const X=s[R]||a;console.log("afficher concept: "+a);const g=document.createElement("span");g.className="indexation-concept";const S=document.createElement("span");S.className="indexation-concept-label",S.textContent=X,g.appendChild(S);const p=document.createElement("a");p.href=a,p.target="_blank",p.rel="noopener",p.className="indexation-concept-link",p.innerHTML='<img src="./up-right-from-square.svg" alt="Ouvrir" style="width:12px;height:12px;" />',g.appendChild(p);const f=document.createElement("button");if(f.title="Supprimer",f.className="indexation-concept-delete",f.innerHTML='<svg width="15" height="15" fill="none" stroke="#b33" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>',f.onclick=()=>$e(a,R,t.uri,t.label),g.appendChild(f),w.appendChild(g),R<n.length-1){const k=document.createElement("span");k.className="indexation-concept-separator",k.textContent=" ; ",w.appendChild(k)}}),T.appendChild(w),e.appendChild(T)}),z.appendChild(e)},V=e=>{var n,s;const t=(s=(n=e["http://www.w3.org/2004/02/skos/core#broader"])==null?void 0:n[0])==null?void 0:s["@id"];if(!t)return null;try{const o=new URL(t,window.location.origin);return new URLSearchParams(o.search).get("idc")||null}catch{return null}},we=()=>{y.innerHTML="Recherche..."},Le=e=>{y.innerHTML=e},K=()=>{if(!Array.isArray(L)||L.length===0){y.innerHTML="Aucun résultat.";return}const e=document.createElement("table");e.className="concepts-table",e.border="1",e.innerHTML=`
      <thead>
        <tr>
          <th style="padding:4px;">Indexation</th>
          <th style="padding:4px;">skos:prefLabel</th>
          <th style="padding:4px;">Terme plus générique</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;const t=e.querySelector("tbody");t&&L.forEach(n=>{t.appendChild(Ie(n))}),y.innerHTML="",y.appendChild(e)},Ie=e=>{const t=document.createElement("tr"),n=Ee(e),s=V(e),o=xe(e);let r=i.idTheso;t.appendChild(getActionCellForConcept(o,n)),t.appendChild(getConceptLabelCell(o,n));const l=document.createElement("td");return l.className="broader-cell",l.textContent=s?"Chargement...":"",t.appendChild(l),e.broaderLabel?l.innerHTML=`${e.broaderLabel} <a href="https://opentheso.huma-num.fr/?idc=${s}&idt=${r}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`:l.innerHTML=`Pas de label <a href="https://opentheso.huma-num.fr/?idc=${s}&idt=${r}" target="_blank" rel="noopener"><img src="./up-right-from-square.svg"/></a>`,t},Ee=e=>{var t,n;return((n=(t=e["http://www.w3.org/2004/02/skos/core#prefLabel"])==null?void 0:t.find(s=>s["@language"]==="fr"))==null?void 0:n["@value"])||"(Sans label)"},xe=e=>"https://opentheso.huma-num.fr"+e["@id"].split("/").pop(),ve=()=>{if(!d){ye();return}Te(),Ce(),K()},Re=(e,t,n)=>{const s=d[t].split(";");s.splice(e,1);const o=s.join(";"),r=d[n].split(";");r.splice(e,1);const l=r.join(";");be({[t]:o,[n]:l},{id:d.id})},Se=async()=>await(await fetch(B+"/v1/thesaurus",{headers:{accept:"application/json;charset=utf-8"}})).json(),ke=async(e,t)=>await(await fetch(B+`/v1/concept/${e}/search?q=${encodeURIComponent(t)}`,{headers:{accept:"application/ld+json;charset=utf-8"}})).json(),Ne=async(e,t)=>await(await fetch(B+`/v1/concept/${e}/${t}/labels`,{headers:{accept:"application/json;charset=utf-8"}})).json(),Oe=()=>{A.innerText="Erreur de chargement."},Me=()=>{M(),F.addEventListener("click",M),H.addEventListener("click",M),ae.addEventListener("click",()=>ze(O.value)),O.addEventListener("keydown",e=>{Ge(e,O.value)}),ie.addEventListener("input",function(){const e=this.value.toLowerCase(),t=x.filter(n=>{var s,o;return(((o=(s=n.labels)==null?void 0:s.find(r=>r.lang==="fr"))==null?void 0:o.title)||"").toLowerCase().includes(e)});W(t)})},W=e=>{A.innerHTML="",e.forEach(t=>{var s,o;const n=document.createElement("div");n.className="thesaurus-item",n.textContent=((o=(s=t.labels)==null?void 0:s.find(r=>r.lang==="fr"))==null?void 0:o.title)||t.idTheso,n.onclick=()=>qe(t),A.appendChild(n)})},Ae=()=>{var t,n;const e=((n=(t=i.labels)==null?void 0:t.find(s=>s.lang==="fr"))==null?void 0:n.title)||i.idTheso;ce.textContent=e,i.idTheso?(N.href=`https://opentheso.huma-num.fr/opentheso/?idt=${encodeURIComponent(i.idTheso)}`,N.style.display="inline-block"):N.style.display="none"},Ue=()=>{G.classList.add("closed"),F.style.display="block",H.style.display="block"},M=()=>{G.classList.remove("closed"),F.style.display="none",H.style.display="none"},Be=async()=>{try{Me(),Se().then(e=>Ve(e))}catch(e){Oe(),console.error(e)}},Fe=()=>{W(x)},He=()=>{Ae(),Ue()},D=async e=>{if(e.trim()){we();try{const t=await ke(i.idTheso,e);await Promise.all(t.map(async n=>{const s=V(n);return s&&(n.broaderLabel=(await Ne(i.idTheso,s)).label),n})),Ke(t)}catch(t){let n;d?i&&i.idTheso?(n="Erreur lors de la recherche dans le thésaurus.",console.error(n,i.idTheso,t)):(n="Veuillez d'abord sélectionner un thésaurus.",console.error(n)):(n="Veuillez d'abord sélectionner une ressource.",console.error(n,i.idTheso,t)),Le(n)}}},Pe=()=>{K()},_e=e=>{console.log("New record selected:",e),re(e),ve()},$e=(e,t,n,s)=>{console.log("Removing concept: ",e),Re(t,n,s)},je=async()=>{Be(),grist.ready({requiredAccess:"full"}),ee(await grist.getTable()),oe(await pe(U)),Y(await grist.docApi.fetchTable("CONFIG")),Q(fe()),ge(),grist.onRecord(e=>{_e(e)})},qe=e=>{console.log("Thesaurus selected:",e),ne(e),He()},ze=e=>{console.log("Searching concepts with query:",e),D(e)},Ge=(e,t)=>{console.log("Searching concepts with query:",t),e.key==="Enter"&&D(t)},Ve=e=>{console.log("Thesauri fetched:",e),te(e),Fe()},Ke=e=>{console.log("Concepts fetched with search:",e),se(e),Pe()},We=async()=>{J(),je()};We();
